%% -*- mode: erlang -*-
{"Erlang/Erlang",
 {[{map,   {modfun, riak_kv_mapreduce, map_object_value},
    {struct,[{<<"sub">>,[<<"0">>]}]},false},
   {reduce,{modfun, riak_kv_mapreduce, reduce_string_to_integer},none,false},
   {reduce,{modfun, riak_kv_mapreduce, reduce_sum},              none,true}],
  simple}}.

{"JS/JS",
 {[{map,    {jsfun, <<"Riak.mapValuesJson">>}, none, false},
   {reduce, {jsfun, <<"Riak.reduceSum">>},     none, true}],
  simple}}.

{"JS/Erlang",
 {[{map,    {jsfun, <<"Riak.mapValuesJson">>},       none, false},
   {reduce, {modfun, riak_kv_mapreduce, reduce_sum}, none, true}],
  simple}}.

{"Erlang/JS",
 {[{map,    {modfun, riak_kv_mapreduce, map_object_value},
    <<"filter_notfound">>, false},
   {reduce, {jsfun, <<"Riak.reduceSort">>},                none, true}],
  sorted}}.

{"JS/Erlang/JS",
 {[{map,    {jsfun, <<"Riak.mapValuesJson">>},        none, false},
   {reduce, {modfun, riak_kv_mapreduce, reduce_sort}, none, false},
   {reduce, {jsfun, <<"Riak.reduceSum">>},            none, true}],
  simple}}.

{"Erlang/JS/Erlang",
 {[{map, {modfun, riak_kv_mapreduce, map_object_value},
    <<"filter_notfound">>, false},
   {reduce, {jsanon,
             <<"function(v) {
                values = Riak.filterNotFound(v);
                return values.map(
                  function(value) {
                    if (typeof value === 'string') {
                      return JSON.parse(value);
                    } else {
                      return value;
                    }
                  });}">>},
                                                        none, false},
   {reduce, {modfun, riak_kv_mapreduce, reduce_sum},    none, true}],
  simple}}.

{"Erlang/JS/JS",
 {[{map, {modfun, riak_kv_mapreduce, map_object_value},
    <<"filter_notfound">>, false},
   {reduce, {jsanon,
             <<"function(v) {
                values = Riak.filterNotFound(v);
                return values.map(
                  function(value) {
                    if (typeof value === 'string') {
                      return JSON.parse(value);
                    } else {
                      return value;
                    }
                  });}">>},
                                                        none, false},
   {reduce, {jsfun, <<"Riak.reduceSum">>},              none, true}],
  simple}}.

{"Erlang map",
 {[{map, {modfun, riak_kv_mapreduce, map_object_value},
    <<"include_notfound">>, true}],
  map}}.

%%slf-has-errors-2011-06-07%%{"JS map",
%%slf-has-errors-2011-06-07%% {[{map, {jsfun, <<"Riak.mapValuesJson">>}, none, true}],
%%slf-has-errors-2011-06-07%%  map}}.
%%slf-has-errors-2011-06-07%%
%%slf-has-errors-2011-06-07%%{"Erlang/JS Link prev",
%%slf-has-errors-2011-06-07%% {[{link, '_', <<"prev">>,               false},
%%slf-has-errors-2011-06-07%%   {map, {jsanon,
%%slf-has-errors-2011-06-07%%          <<"function(v,d) {
%%slf-has-errors-2011-06-07%%                if (d == 'prev')
%%slf-has-errors-2011-06-07%%                   return [v.key];
%%slf-has-errors-2011-06-07%%                else
%%slf-has-errors-2011-06-07%%                   return [];
%%slf-has-errors-2011-06-07%%             }">>},
%%slf-has-errors-2011-06-07%%                                   none, true}],
%%slf-has-errors-2011-06-07%%  map}}.

{"Erlang/Erlang link prev",
{[{link, '_', <<"prev">>,               false},
  {map, {modfun, riak_kv_mapreduce, map_object_value},
   <<"include_notfound">>, true}],
 map}}.

% SLF: Hrmm, broken, should figure out why
%% {"Erlang/Erlang SLF hack 2",
%% {[{map,    {modfun, riak_kv_mapreduce, map_object_value},
%%    <<"filter_notfound">>, false},
%%   {reduce,{modfun, riak_kv_mapreduce, reduce_sort},              none,true}],
%%  simple}}.

